<!DOCTYPE html>
<html>
<head>
  <title>Nahrávání audia</title>
</head>
<body>
  <h1>Nahraj hlas a analyzuj</h1>
  <button id="startBtn">Start</button>
  <button id="stopBtn" disabled>Stop</button>
  <pre id="output"></pre>

  <script>
  let stream;
  let recording = false;
  let intervalId;
  let chunkIndex = 0;

  async function startRecording() {
    stream = await navigator.mediaDevices.getUserMedia({ audio: true });
    recording = true;
    chunkIndex = 0;
    loopRecording();
  }

  function loopRecording() {
    if (!recording) return;

    const mediaRecorder = new MediaRecorder(stream);
    const chunks = [];

    mediaRecorder.ondataavailable = e => {
      chunks.push(e.data);
    };

    mediaRecorder.onstop = async () => {
      const blob = new Blob(chunks, { type: 'audio/webm' });
      const formData = new FormData();
      formData.append("audio_data", blob, `chunk_${chunkIndex}.webm`);

      try {
        const res = await fetch("/upload", {
          method: "POST",
          body: formData
        });
        const data = await res.json();
        console.log("Chunk", chunkIndex, data);
      } catch (err) {
        console.error("Upload error", err);
      }

      chunkIndex++;

      // Rekurzivní volání = pokračuj
      loopRecording();
    };

    mediaRecorder.start();

    // Stopni po 1 sekundě (nebo kolik chceš)
    setTimeout(() => {
      mediaRecorder.stop();
    }, 1000);
  }

  function stopRecording() {
    recording = false;
    stream.getTracks().forEach(track => track.stop());
  }

  document.getElementById("startBtn").onclick = () => {
    startRecording();
    document.getElementById("stopBtn").disabled = false;
    document.getElementById("startBtn").disabled = true;
  };

  document.getElementById("stopBtn").onclick = () => {
    stopRecording();
    document.getElementById("stopBtn").disabled = true;
    document.getElementById("startBtn").disabled = false;
  };
</script>

</body>
</html>
